<!DOCTYPE html><html lang="en" class="h-full"><head><meta charSet="utf-8"/><title>Implementing Webhooks in Node.js</title><meta name="description" content="Get hands-on with Webhooks and avoid some common gotchas."/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta property="og:type" content="website"/><meta property="og:image" content="https://workshops.shopify.dev/social-share-preview.jpg"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://workshops.shopify.dev/social-share-preview.jpg"/><meta name="twitter:creator" content="@ShopifyDevs"/><link rel="stylesheet" href="/build/_assets/tailwind-OSF3KDF6.css"/><link rel="stylesheet" href="/build/_assets/workshops-IXG5EJLE.css"/><link rel="stylesheet" href="/build/_assets/agate-YFU2QRW6.css"/></head><body class="h-full bg-slate-50"><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-86JJCZ26ZM"></script><script async="" id="gtag-init">
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
              </script><main><div class="workshop flex h-full w-full flex-row justify-between gap-0"><header class="fixed top-0 left-0 right-0 z-[2] flex flex-row-reverse items-center justify-end bg-white p-4 drop-shadow-md md:justify-between"><div class="hidden md:block timer"><p>45<!-- --> minutes remaining</p></div><h1>Implementing Webhooks in Node.js</h1><button class="btn-icon md:hidden" aria-label="Open step navigation"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 013.75 6h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 6.75zM3 12a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 12zm0 5.25a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75a.75.75 0 01-.75-.75z" clip-rule="evenodd"></path></svg></button><a class="btn-icon hidden md:block" arial-label="Go back to workshops" href="/"><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="h-5 w-5"><path d="M19 9H3.661l5.997-5.246a1 1 0 00-1.316-1.506l-8 7c-.008.007-.011.018-.019.025a.975.975 0 00-.177.24c-.018.03-.045.054-.059.087a.975.975 0 000 .802c.014.033.041.057.059.088.05.087.104.17.177.239.008.007.011.018.019.025l8 7a.996.996 0 001.411-.095 1 1 0 00-.095-1.411L3.661 11H19a1 1 0 000-2z"></path></svg></a></header>
<div class="workshop-nav flex shrink-0 flex-col gap-2 bg-slate-50"><a class="flex select-none items-center rounded-md px-4 pb-2 leading-snug md:hidden" href="/"><svg width="8.4" height="12" viewBox="0 0 7 10" fill="none" xmlns="http://www.w3.org/2000/svg" focusable="false" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.30326 0.403358C5.108 0.208096 4.79142 0.208096 4.59615 0.403358L1.06062 3.93889L0.353513 4.646C0.158251 4.84126 0.158251 5.15784 0.353513 5.35311L1.06062 6.06021L4.59615 9.59575C4.79142 9.79101 5.108 9.79101 5.30326 9.59575L6.01037 8.88864C6.20563 8.69338 6.20563 8.37679 6.01037 8.18153L2.82839 4.99955L6.01037 1.81757C6.20563 1.62231 6.20563 1.30573 6.01037 1.11046L5.30326 0.403358Z" fill="currentColor"></path></svg><span class="pl-2">Workshops</span></a><hr class="md:hidden"/><div class="flex select-none items-center rounded-md py-4 px-4 leading-snug md:hidden timer"><p>45<!-- --> minutes remaining</p></div><a href="#0" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug font-medium"><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-emerald-500">1</span>Before you begin</a><a href="#1" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">2</span>Introduction to webhooks</a><a href="#2" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">3</span>Configure a webhook in the admin</a><a href="#3" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">4</span>Run an ngrok tunnel</a><a href="#4" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">5</span>Create an app</a><a href="#5" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">6</span>Configuring the webhook</a><a href="#6" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">7</span>Trigger a notification using the CLI</a><a href="#7" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">8</span>Metrics Dashboard</a><a href="#8" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">9</span>Tagging the product</a><a href="#9" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">10</span>Removing tags</a><a href="#10" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">11</span>Cleaning up the code</a><a href="#11" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">12</span>Implementing a queue</a><a href="#12" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">13</span>Handling duplicates</a><a href="#13" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">14</span>Reconciliation jobs</a><a href="#14" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">15</span>Conclusion</a><a href="#15" class="flex select-none items-center rounded-md border border-solid border-gray-200 bg-white py-4 px-4 leading-snug "><span class="mr-4 flex h-6 w-6 flex-none items-center justify-center rounded-full  text-[0.8rem] leading-6 text-white bg-slate-400">16</span>Get ready to scale</a></div><div class="backdrop fixed inset-0"></div>
<div class="slider-wrapper"><div class="slider-panel"><div class="workshop-step"><section><h2 id="0">Before you begin</h2><p>In this workshop we&#x27;ll get hands-on with Webhooks. We&#x27;ll look at what webhooks are, why you&#x27;d use them and how to handle some common gotchas.</p><h3>Learning Objectives</h3><p>After you&#x27;ve finished this tutorial, you&#x27;ll have accomplished the following:</p><ul>
<li>Learned the what, why and how of webhooks</li>
<li>Created a webhook subscription via the Shopify Admin</li>
<li>Implemented a webhook subscription programmatically</li>
<li>Implemented a queue to store and process webhooks</li>
<li>Efficiently handled duplicate notifications</li>
<li>Implemented a job to reconcile data</li>
</ul><h3>What you&#x27;ll need</h3><ul>
<li>Create a Shopify partner account</li>
<li>Create a development store</li>
<li>Node 14.13 or higher</li>
<li>Your favorite code editor</li>
</ul><p>To view the complete source code for this workshop, <a href="https://github.com/Shopify/workshop-webhooks-nodejs">check out this repo</a>.</p></section></div></div><div class="slider-controls"><button class="slider-control btn btn-small btn-tertiary-outline prev shadow-md invisible" disabled="">Back</button><button class="slider-control btn btn-small btn-tertiary next shadow-md ">Next</button></div></div></div></main><script>((STORAGE_KEY, restoreKey) => {
    if (!window.history.state || !window.history.state.key) {
      let key = Math.random().toString(32).slice(2);
      window.history.replaceState({
        key
      }, "");
    }
    try {
      let positions = JSON.parse(sessionStorage.getItem(STORAGE_KEY) || "{}");
      let storedY = positions[restoreKey || window.history.state.key];
      if (typeof storedY === "number") {
        window.scrollTo(0, storedY);
      }
    } catch (error) {
      console.error(error);
      sessionStorage.removeItem(STORAGE_KEY);
    }
  })("positions", null)</script><link rel="modulepreload" href="/build/entry.client-J6TYPMOL.js"/><link rel="modulepreload" href="/build/_shared/chunk-YZBVNK3V.js"/><link rel="modulepreload" href="/build/_shared/chunk-SH7JW3YP.js"/><link rel="modulepreload" href="/build/_shared/chunk-GDLBX7ER.js"/><link rel="modulepreload" href="/build/_shared/chunk-Q3IECNXJ.js"/><link rel="modulepreload" href="/build/_shared/chunk-JOBPDGDE.js"/><link rel="modulepreload" href="/build/_shared/chunk-MV3Y6IQI.js"/><link rel="modulepreload" href="/build/root-TS7GWK7I.js"/><link rel="modulepreload" href="/build/routes/workshops-YWZAAF22.js"/><link rel="modulepreload" href="/build/_shared/chunk-4QTFVEPO.js"/><link rel="modulepreload" href="/build/routes/workshops/$workshopId-TCVFMZD7.js"/><script>window.__remixContext = {"url":"/workshops/webhooks-in-nodejs","state":{"loaderData":{"root":{"trackingEnabled":true},"routes/workshops/$workshopId":{"workshopId":"webhooks-in-nodejs","code":"var Component=(()=\u003e{var p=Object.create;var r=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var y=(a,e)=\u003e()=\u003e(e||a((e={exports:{}}).exports,e),e.exports),g=(a,e)=\u003e{for(var l in e)r(a,l,{get:e[l],enumerable:!0})},i=(a,e,l,c)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let n of j(e))!N.call(a,n)\u0026\u0026n!==l\u0026\u0026r(a,n,{get:()=\u003ee[n],enumerable:!(c=m(e,n))||c.enumerable});return a};var w=(a,e,l)=\u003e(l=a!=null?p(u(a)):{},i(e||!a||!a.__esModule?r(l,\"default\",{value:a,enumerable:!0}):l,a)),k=a=\u003ei(r({},\"__esModule\",{value:!0}),a);var t=y((S,h)=\u003e{h.exports=_jsx_runtime});var _={};g(_,{default:()=\u003ev,frontmatter:()=\u003ef});var s=w(t()),f={id:\"webhooks-in-nodejs\",summary:\"Get hands-on with Webhooks and avoid some common gotchas.\",title:\"Implementing Webhooks in Node.js\",status:\"Published\",categories:\"shopify, webhooks\"};function o(a){let e=Object.assign({timer:\"timer\",h1:\"h1\",nav:\"nav\",\"workshop-steps\":\"workshop-steps\",div:\"div\",section:\"section\",h2:\"h2\",p:\"p\",h3:\"h3\",ul:\"ul\",li:\"li\",a:\"a\",img:\"img\",pre:\"pre\",code:\"code\",span:\"span\",ol:\"ol\",strong:\"strong\",dl:\"dl\",dt:\"dt\",dd:\"dd\",em:\"em\"},a.components),l=e[\"workshop-steps\"],{WorkshopHeader:c,WorkshopNavLink:n}=e;return c||d(\"WorkshopHeader\",!0),n||d(\"WorkshopNavLink\",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(c,{children:[(0,s.jsx)(e.timer,{cssClass:\"hidden md:block\",children:'{\"total\":45,\"stepsDuration\":{\"1\":2,\"2\":5,\"3\":3,\"4\":2,\"5\":3,\"6\":4,\"7\":2,\"8\":2,\"9\":2,\"10\":3,\"11\":3,\"12\":4,\"13\":3,\"14\":5,\"15\":2},\"countDown\":[]}'}),(0,s.jsx)(e.h1,{children:\"Implementing Webhooks in Node.js\"})]}),`\n`,(0,s.jsxs)(e.nav,{children:[(0,s.jsx)(e.timer,{cssClass:\"flex select-none items-center rounded-md py-4 px-4 leading-snug md:hidden\",children:'{\"total\":45,\"stepsDuration\":{\"1\":2,\"2\":5,\"3\":3,\"4\":2,\"5\":3,\"6\":4,\"7\":2,\"8\":2,\"9\":2,\"10\":3,\"11\":3,\"12\":4,\"13\":3,\"14\":5,\"15\":2},\"countDown\":[]}'}),(0,s.jsx)(n,{stepStr:\"0\",children:\"Before you begin\"}),(0,s.jsx)(n,{stepStr:\"1\",children:\"Introduction to webhooks\"}),(0,s.jsx)(n,{stepStr:\"2\",children:\"Configure a webhook in the admin\"}),(0,s.jsx)(n,{stepStr:\"3\",children:\"Run an ngrok tunnel\"}),(0,s.jsx)(n,{stepStr:\"4\",children:\"Create an app\"}),(0,s.jsx)(n,{stepStr:\"5\",children:\"Configuring the webhook\"}),(0,s.jsx)(n,{stepStr:\"6\",children:\"Trigger a notification using the CLI\"}),(0,s.jsx)(n,{stepStr:\"7\",children:\"Metrics Dashboard\"}),(0,s.jsx)(n,{stepStr:\"8\",children:\"Tagging the product\"}),(0,s.jsx)(n,{stepStr:\"9\",children:\"Removing tags\"}),(0,s.jsx)(n,{stepStr:\"10\",children:\"Cleaning up the code\"}),(0,s.jsx)(n,{stepStr:\"11\",children:\"Implementing a queue\"}),(0,s.jsx)(n,{stepStr:\"12\",children:\"Handling duplicates\"}),(0,s.jsx)(n,{stepStr:\"13\",children:\"Reconciliation jobs\"}),(0,s.jsx)(n,{stepStr:\"14\",children:\"Conclusion\"}),(0,s.jsx)(n,{stepStr:\"15\",children:\"Get ready to scale\"})]}),`\n`,(0,s.jsxs)(l,{children:[(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"0\",children:\"Before you begin\"}),(0,s.jsx)(e.p,{children:\"In this workshop we'll get hands-on with Webhooks. We'll look at what webhooks are, why you'd use them and how to handle some common gotchas.\"}),(0,s.jsx)(e.h3,{children:\"Learning Objectives\"}),(0,s.jsx)(e.p,{children:\"After you've finished this tutorial, you'll have accomplished the following:\"}),(0,s.jsxs)(e.ul,{children:[`\n`,(0,s.jsx)(e.li,{children:\"Learned the what, why and how of webhooks\"}),`\n`,(0,s.jsx)(e.li,{children:\"Created a webhook subscription via the Shopify Admin\"}),`\n`,(0,s.jsx)(e.li,{children:\"Implemented a webhook subscription programmatically\"}),`\n`,(0,s.jsx)(e.li,{children:\"Implemented a queue to store and process webhooks\"}),`\n`,(0,s.jsx)(e.li,{children:\"Efficiently handled duplicate notifications\"}),`\n`,(0,s.jsx)(e.li,{children:\"Implemented a job to reconcile data\"}),`\n`]}),(0,s.jsx)(e.h3,{children:\"What you'll need\"}),(0,s.jsxs)(e.ul,{children:[`\n`,(0,s.jsx)(e.li,{children:\"Create a Shopify partner account\"}),`\n`,(0,s.jsx)(e.li,{children:\"Create a development store\"}),`\n`,(0,s.jsx)(e.li,{children:\"Node 14.13 or higher\"}),`\n`,(0,s.jsx)(e.li,{children:\"Your favorite code editor\"}),`\n`]}),(0,s.jsxs)(e.p,{children:[\"To view the complete source code for this workshop, \",(0,s.jsx)(e.a,{href:\"https://github.com/Shopify/workshop-webhooks-nodejs\",children:\"check out this repo\"}),\".\"]})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"1\",children:\"Introduction to webhooks\"}),(0,s.jsx)(e.p,{children:\"Webhooks are notifications of events. They allow apps to stay in sync with Shopify data or perform an action after a specific event occurs in a shop. This is in contrast to repeatedly polling Shopify looking for changes.\"}),(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/polling-vs-webhooks.jpg\",alt:\"Polling vs webhook subscriptions\"})}),(0,s.jsxs)(e.p,{children:[\"For example: a webhook can let you know each time a merchant updates a product, or receives an order, or updates a theme. There are a ton of events (aka topics) that you can subscribe to, from product updates to order fulfilments. You can find \",(0,s.jsx)(e.a,{href:\"https://shopify.dev/api/admin-rest/2022-10/resources/webhook#event-topics\",children:\"a full list of topics here\"}),\".\"]}),(0,s.jsx)(e.p,{children:\"When creating a webhook subscription, you specify a URL (the URL that should be notified of events), a topic (the event you'd like to subscribe to), a format (JSON or XML) and an API version number.\"}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-json\",children:[(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"{\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"webhook\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"{\"}),`\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"topic\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"products/update\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"address\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"https://12345.ngrok.io/\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"format\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"json\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"api_version\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"2022-10\"'}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"}\"}),`\n`,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"}\"}),`\n`]})}),(0,s.jsx)(e.p,{children:\"When Shopify sends a notification, it contains a payload with information about the event. Here's an example payload sent for product update events:\"}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-json\",children:[(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"{\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"id\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"7049465266315\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"title\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"Wispy Bush\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"body_html\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"null\"})}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"product_type\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"created_at\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"2022-11-29T21:57:20-05:00\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"handle\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"wispy-bush\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"updated_at\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"2022-11-29T23:31:38-05:00\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"published_at\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"null\"})}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"template_suffix\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"null\"})}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"status\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"active\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"published_scope\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"web\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"tags\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"[\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"]\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"admin_graphql_api_id\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"gid://shopify/Product/7049465266315\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"variants\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"[\"}),`\n    `,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"{\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"id\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"41100369363083\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"product_id\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"7049465266315\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"title\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"Default Title\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"price\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"8.17\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"sku\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"position\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"1\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      \\u2026\n    `,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"}\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"]\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"options\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"[\"}),`\n    `,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"{\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"id\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"9080925945995\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"product_id\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"7049465266315\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"name\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"Title\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"position\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"1\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"values\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"[\"}),`\n        `,(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"Default Title\"'}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"]\"}),`\n    `,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"}\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"]\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"images\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"[\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"]\"}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\",\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"image\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"null\"})}),`\n`,(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\"}\"}),`\n`]})})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"2\",children:\"Configure a webhook in the admin\"}),(0,s.jsx)(e.p,{children:\"Before diving into any code, we'll configure a webhook from the Shopify Admin for a single merchant. Apps subscribe programmatically, which will be covered next.\"}),(0,s.jsxs)(e.ol,{children:[`\n`,(0,s.jsxs)(e.li,{children:[`\n`,(0,s.jsxs)(e.p,{children:[\"First, we need a server to receive the notification. Instead of spinning up a server, we can use a handy service like Webhook.site to easily inspect incoming HTTP requests.\",(0,s.jsx)(\"br\",{}),(0,s.jsx)(\"br\",{}),\"Head to \",(0,s.jsx)(e.a,{href:\"https://webhook.site\",children:\"https://webhook.site\"}),\". A unique URL is created for you. Copy it to clipboard and keep the tab open, we'll be back here shortly.\",(0,s.jsx)(\"br\",{}),(0,s.jsx)(\"br\",{}),(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/webhook-site.jpg\",alt:\"webhook.site\"})]}),`\n`]}),`\n`,(0,s.jsxs)(e.li,{children:[`\n`,(0,s.jsxs)(e.p,{children:[\"From your test store's admin, head to \",(0,s.jsx)(e.strong,{children:\"Settings \u003e Notifications\"}),\". Scroll down to Webhooks and click \",(0,s.jsx)(e.strong,{children:\"Create webhook\"}),\".\"]}),`\n`]}),`\n`,(0,s.jsxs)(e.li,{children:[`\n`,(0,s.jsxs)(e.p,{children:[\"Set the topic to Product Update, the format to JSON, the endpoint URL you created in step one and the API version to latest.\",(0,s.jsx)(\"br\",{}),(0,s.jsx)(\"br\",{}),(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/admin-add-webhook.jpg\",alt:\"add a webhook\"})]}),`\n`]}),`\n`,(0,s.jsxs)(e.li,{children:[`\n`,(0,s.jsxs)(e.p,{children:[\"Click \",(0,s.jsx)(e.strong,{children:\"save\"}),\". You'll see the new webhook listed. With this in place, we'll be notified each time a product is updated.\"]}),`\n`]}),`\n`,(0,s.jsxs)(e.li,{children:[`\n`,(0,s.jsx)(e.p,{children:\"The last step - you guessed it: time to update a product! With the Webhook.site console open, head to your products and update a product. If you don't have any products in your test store, create one - this will also trigger a product update event.\"}),`\n`]}),`\n`]}),(0,s.jsxs)(e.p,{children:[\"You should see the webhook has been received. The body (aka the payload) contains information about the updated product. You can also view the headers which contain information about which store triggered the event, the topic and a hash which allows us to verify the webhooks.\",(0,s.jsx)(\"br\",{}),(0,s.jsx)(\"br\",{}),(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/webhook-site-payload.jpg\",alt:\"webhook.site request\"})]}),(0,s.jsx)(e.h3,{children:\"Why would you verify the webhook?\"}),(0,s.jsxs)(e.p,{children:[\"These webhook endpoints are publicly accessible, which means anyone could send any payload. To confirm the request came from Shopify (and wasn't modified along the way), you can calculate a digital signature and compare it to the \",(0,s.jsx)(e.code,{children:\"x-shopify-hmac-sha256\"}),\" header. \",(0,s.jsx)(e.a,{href:\"https://shopify.dev/apps/webhooks/configuration/https#step-5-verify-the-webhook\",children:\"More on that here\"}),\".\"]}),(0,s.jsxs)(e.dl,{children:[(0,s.jsx)(e.dt,{children:\"Positive\"}),(0,s.jsx)(e.dd,{children:\"Don't forget to clean up! Delete the webhook from the Shopify admin.\"})]})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"3\",children:\"Run an ngrok tunnel\"}),(0,s.jsx)(e.p,{children:\"Shopify CLI uses ngrok to create a tunnel that allows your app to be accessed using a unique HTTPS URL.\"}),(0,s.jsx)(e.p,{children:\"Soon we'll be registering some webhooks and specifying a URL. Given your ngrok URL changes when you restart the server, we'll run ngrok manually in a separate tab to keep the address static.\"}),(0,s.jsx)(e.p,{children:\"In a new terminal window, run a tunnel on port 3000:\"}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:\"hljs language-bash\",children:`ngrok http 3000\n`})}),(0,s.jsx)(e.p,{children:\"Take note of the forwarding tunnel URL, we'll need it in the next step!\"})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"4\",children:\"Create an app\"}),(0,s.jsx)(e.p,{children:\"Next, we will programmatically subscribe to a webhook. We'll build an app which tags products that don't contain photos.\"}),(0,s.jsxs)(e.p,{children:[\"To get started, we'll boostrap the app using the Shopify App CLI. In a new command line tab, navigate to the directory where you want to create your app. Generate a new app and \",(0,s.jsx)(e.strong,{children:\"Choose the Node option\"}),\". Your app will be created in a new subdirectory.\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-bash\",children:[`npm init @shopify/app@latest\n`,(0,s.jsx)(e.span,{className:\"hljs-built_in\",children:\"cd\"}),` \u003cyour-app\u003e\n`]})}),(0,s.jsxs)(e.p,{children:[\"Before running the app, open the code and update \",(0,s.jsx)(e.code,{children:\"./package.json\"}),\"'s \",(0,s.jsx)(e.code,{children:\"dev\"}),\" script to include your new ngrok URL.\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-json\",children:[(0,s.jsx)(e.span,{className:\"hljs-attr\",children:'\"dev\"'}),(0,s.jsx)(e.span,{className:\"hljs-punctuation\",children:\":\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"shopify app dev --tunnel-url=https://[your-ngrok-url-here]:3000\"'}),`\n`]})}),(0,s.jsx)(e.p,{children:\"Next, run the app.\"}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:\"hljs language-bash\",children:`npm run dev\n`})}),(0,s.jsx)(e.p,{children:\"When prompted, create the project as a new app and provide a name. The value provided here is how your app will show up in your Partner Dashboard. If you have more than one Partner organization or development store, you will also be prompted to select them as well.\"}),(0,s.jsxs)(e.dl,{children:[(0,s.jsx)(e.dt,{children:\"Negative\"}),(0,s.jsx)(e.dd,{children:\"Don't install the app just yet! (webhooks are registered when the app is installed).\"})]})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"5\",children:\"Configuring the webhook\"}),(0,s.jsx)(e.p,{children:\"Time to implement a webhook subscription using code! Stop the developement server and open the project in your code editor.\"}),(0,s.jsxs)(e.p,{children:[\"The project contains \",(0,s.jsx)(e.a,{href:\"https://github.com/Shopify/shopify-api-js\",children:(0,s.jsx)(e.code,{children:\"@shopify/shopify-api\"})}),\" which handles lots of the work for us and makes subscribing to webhooks a breeze.\"]}),(0,s.jsxs)(e.p,{children:[\"Open \",(0,s.jsx)(e.code,{children:\"/web/gdpr.js\"}),\" to see the current webhook subscriptions. These are required webhooks and include topics like \",(0,s.jsx)(e.code,{children:\"CUSTOMERS_DATA_REQUEST\"}),\" which allows customers to request their data from a store owner.\"]}),(0,s.jsxs)(e.p,{children:[\"We'll add another topic: \",(0,s.jsx)(e.code,{children:\"PRODUCT_UPDATE\"}),\" at the top of the exports to subscribe to product updates.\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\" } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"@shopify/shopify-api\"'}),`;\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"default\"}),` {\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"PRODUCTS_UPDATE\"}),`: {\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"deliveryMethod\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"Http\"}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callbackUrl\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/api/webhooks\"'}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callback\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),` (topic, shop, body, webhookId) =\u003e {\n      `,(0,s.jsx)(e.span,{className:\"hljs-variable language_\",children:\"console\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"log\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'--- Product update ---'\"}),`);\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" payload = \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"JSON\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"parse\"}),`(body);\n      `,(0,s.jsx)(e.span,{className:\"hljs-variable language_\",children:\"console\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"log\"}),`(payload);\n      `,(0,s.jsx)(e.span,{className:\"hljs-variable language_\",children:\"console\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"log\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'--- /Product update ---'\"}),`);\n    },\n  },\n  ...\n`]})}),(0,s.jsx)(e.p,{children:\"Since this file now handles more than GDPR, let's rename it.\"}),(0,s.jsxs)(e.ol,{children:[`\n`,(0,s.jsxs)(e.li,{children:[`\n`,(0,s.jsxs)(e.p,{children:[\"Rename the \",(0,s.jsx)(e.code,{children:\"/web/gdpr.js\"}),\" to \",(0,s.jsx)(e.code,{children:\"/web/webhook-handlers.js\"})]}),`\n`]}),`\n`,(0,s.jsxs)(e.li,{children:[`\n`,(0,s.jsxs)(e.p,{children:[\"Update the import in \",(0,s.jsx)(e.code,{children:\"web/index.js\"}),\".\",(0,s.jsx)(\"br\",{}),(0,s.jsx)(\"br\",{}),\"Replace: \",(0,s.jsx)(e.code,{children:'import GDPRWebhookHandlers from \"./gdpr.js\";'})]}),`\n`,(0,s.jsxs)(e.p,{children:[\"With: \",(0,s.jsx)(e.code,{children:'import webhookHandlers from \"./webhook-handlers.js\";'})]}),`\n`]}),`\n`,(0,s.jsxs)(e.li,{children:[`\n`,(0,s.jsxs)(e.p,{children:[\"Update the route in \",(0,s.jsx)(e.code,{children:\"web/index.js\"}),\":\"]}),`\n`]}),`\n`]}),(0,s.jsx)(e.p,{children:\"Replace:\"}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[\"app.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"post\"}),`(\n  shopify.`,(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"config\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"webhooks\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"path\"}),`,\n  shopify.`,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"processWebhooks\"}),\"({ \",(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"webhookHandlers\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"GDPRWebhookHandlers\"}),` })\n);\n`]})}),(0,s.jsx)(e.p,{children:\"With:\"}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[\"app.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"post\"}),\"( shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"config\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"webhooks\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"path\"}),\", shopify.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"processWebhooks\"}),`({\n  webhookHandlers\n}) );\n`]})}),(0,s.jsx)(e.p,{children:`Run the app and install it on your development store by opening the shareable app URL\nshown in the terminal.`}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:\"hljs language-bash\",children:`npm run dev\n`})}),(0,s.jsx)(e.p,{children:\"Confirm everything's working by making a change to a product. Keep an eye on your terminal - you should see a notification come through:\"}),(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/console-webhook.jpg\",alt:\"webhook request in console\"})}),(0,s.jsxs)(e.dl,{children:[(0,s.jsx)(e.dt,{children:\"Positive\"}),(0,s.jsx)(e.dd,{children:\"We don't need to manually verify the notification - the library takes care of this for us!\"})]})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"6\",children:\"Trigger a notification using the CLI\"}),(0,s.jsx)(e.p,{children:\"You can also trigger a webhook test payload directly from the CLI. This makes it easy to test your subscriptions for each topic, so you can see what the payload will look like before your app is in production.\"}),(0,s.jsx)(e.p,{children:\"Open a new command line tab at the root of your project and run:\"}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:\"hljs language-bash\",children:`npm run shopify webhook trigger\n`})}),(0,s.jsx)(e.p,{children:\"You'll be prompted for:\"}),(0,s.jsxs)(e.ul,{children:[`\n`,(0,s.jsxs)(e.li,{children:[\"A topic (e.g. \",(0,s.jsx)(e.code,{children:\"products/update\"}),\")\"]}),`\n`,(0,s.jsxs)(e.li,{children:[\"An API version (e.g. \",(0,s.jsx)(e.code,{children:\"2022-10\"}),\")\"]}),`\n`,(0,s.jsx)(e.li,{children:\"A Shared Secret (aka your client secret from the partner dashboard)\"}),`\n`,(0,s.jsxs)(e.li,{children:[\"A delivery method (Select \",(0,s.jsx)(e.code,{children:\"HTTP\"}),\")\"]}),`\n`,(0,s.jsxs)(e.li,{children:[\"And an address for delivery (\",(0,s.jsx)(e.code,{children:\"https://[your-ngrok-url-here]/api/webhooks\"}),\")\"]}),`\n`]}),(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/cli-trigger-notification.jpg\",alt:\"using the CLI to trigger a test webhook notification\"})}),(0,s.jsx)(e.p,{children:\"Keep an eye on your developer server logs - you should see the test payload come through!\"})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"7\",children:\"Metrics Dashboard\"}),(0,s.jsxs)(e.p,{children:[\"This is a good time to check out the webhooks dashboard. From your Partner Dashboard, select the new application and head to \",(0,s.jsx)(e.strong,{children:\"Insights \u003e Webhooks\"}),\".\"]}),(0,s.jsx)(e.p,{children:\"We can use the delivery metrics dashboard to track webhook deliveries (and failures!).\"}),(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/webhook-dashboard.jpg\",alt:\"webhook dashboard\"})})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"8\",children:\"Tagging the product\"}),(0,s.jsxs)(e.p,{children:[\"On to the tagging! First, we'll use the \",(0,s.jsx)(e.code,{children:\"shopify-api-node\"}),\" library to create a client so we're able to update products on behalf of the shop.\"]}),(0,s.jsxs)(e.p,{children:[\"Navigate to \",(0,s.jsx)(e.code,{children:\"/web/webhook-handlers.js\"}),\":\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\" } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"@shopify/shopify-api\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" shopify \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./shopify.js\"'}),`;\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"default\"}),` {\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"PRODUCTS_UPDATE\"}),`: {\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"deliveryMethod\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"Http\"}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callbackUrl\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/api/webhooks\"'}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callback\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),` (topic, shop, body, webhookId) =\u003e {\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" sessionId = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"session\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"getOfflineId\"}),`(shop)\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" session = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"config\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"sessionStorage\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"loadSession\"}),`(sessionId);\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" client = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"new\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"clients\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Rest\"}),`({session});\n    },\n  },\n  ...\n`]})}),(0,s.jsxs)(e.p,{children:[\"Next, we'll examine products to determine whether or not they should be tagged. If a product doesn't have any images, we'll add a \",(0,s.jsx)(e.code,{children:\"no-photos\"}),\" tag.\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\" } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"@shopify/shopify-api\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" shopify \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./shopify.js\"'}),`;\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"default\"}),` {\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"PRODUCTS_UPDATE\"}),`: {\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"deliveryMethod\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"Http\"}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callbackUrl\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/api/webhooks\"'}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callback\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),` (topic, shop, body, webhookId) =\u003e {\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" sessionId = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"session\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"getOfflineId\"}),`(shop)\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" session = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"config\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"sessionStorage\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"loadSession\"}),`(sessionId);\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" client = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"new\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"clients\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Rest\"}),`({session});\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" product = \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"JSON\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"parse\"}),`(body);\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" images = product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"images\"}),`;\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" tags = product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\" ? product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"split\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"','\"}),`) : [];\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),` data = {\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"product\"}),`: {\n          `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"id\"}),\": product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"id\"}),`,\n          `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"tags\"}),`: [...tags]\n        },\n      }\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Add tag if there are no products\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"if\"}),\" (!images.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"length\"}),\" \u0026\u0026 !tags.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"includes\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'no-photos'\"}),`)) {\n        data.`,(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"product\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"push\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'no-photos'\"}),`)\n        `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" products = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" client.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"put\"}),`({\n          `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"path\"}),\": \",(0,s.jsxs)(e.span,{className:\"hljs-string\",children:[\"`products/\",(0,s.jsx)(e.span,{className:\"hljs-subst\",children:\"${product.id}\"}),\".json`\"]}),`,\n          data,\n        });\n      }\n    },\n  },\n  ...\n`]})})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"9\",children:\"Removing tags\"}),(0,s.jsxs)(e.p,{children:[\"Since photos can be added \",(0,s.jsx)(e.em,{children:\"and\"}),\" removed, we should also add some logic to remove the tag if a product eventually has photos.\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\" } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"@shopify/shopify-api\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" shopify \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./shopify.js\"'}),`;\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"default\"}),` {\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"PRODUCTS_UPDATE\"}),`: {\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"deliveryMethod\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"Http\"}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callbackUrl\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/api/webhooks\"'}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callback\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),` (topic, shop, body, webhookId) =\u003e {\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" sessionId = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"session\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"getOfflineId\"}),`(shop)\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" session = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"config\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"sessionStorage\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"loadSession\"}),`(sessionId);\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" client = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"new\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"clients\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Rest\"}),`({session});\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" product = \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"JSON\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"parse\"}),`(body);\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" images = product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"images\"}),`;\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" tags = product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\" ? product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"split\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"','\"}),`) : [];\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),` data = {\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"product\"}),`: {\n          `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"id\"}),\": product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"id\"}),`,\n          `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"tags\"}),`: [...tags]\n        },\n      }\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Add tag if there are no products\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"if\"}),\" (!images.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"length\"}),\" \u0026\u0026 !tags.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"includes\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'no-photos'\"}),`)) {\n        data.`,(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"product\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"push\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'no-photos'\"}),`)\n      }\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Remove tag if there are photos\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"if\"}),\" (images.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"length\"}),\" \u0026\u0026 tags.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"includes\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'no-photos'\"}),`)) {\n        `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" index = data.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"product\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"indexOf\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'no-photos'\"}),`);\n        data.`,(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"product\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"splice\"}),\"(index, \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"1\"}),`);\n      }\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Update the tags if they've changed\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"if\"}),\" (tags.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"length\"}),\" !== data.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"product\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"length\"}),`) {\n        `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" products = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" client.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"put\"}),`({\n          `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"path\"}),\": \",(0,s.jsxs)(e.span,{className:\"hljs-string\",children:[\"`products/\",(0,s.jsx)(e.span,{className:\"hljs-subst\",children:\"${product.id}\"}),\".json`\"]}),`,\n          data,\n        })\n      }\n\n    },\n  },\n  ...\n`]})}),(0,s.jsx)(e.p,{children:\"Open a product and add or remove images. This will trigger a product update event. Products should be tagged if they don't contain images (you'll need to refresh the admin to see the tags!).\"}),(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/admin-tags.jpg\",alt:\"product tags in the Shopify admin\"})})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"10\",children:\"Cleaning up the code\"}),(0,s.jsx)(e.p,{children:\"Let's clean up the code a little and move it into its own file for reuse in other parts of our app.\"}),(0,s.jsxs)(e.p,{children:[\"Create a file \",(0,s.jsx)(e.code,{children:\"/web/product-tagger.js\"}),\":\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-variable constant_\",children:\"TAG_NO_PHOTOS\"}),\" = \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"no-photos\"'}),`;\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"default\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"function\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"productTagger\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-params\",children:\"client, product\"}),`) {\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" images = product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"images\"}),`;\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" tags = product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\" ? product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"split\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\",\"'}),`) : [];\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),` data = {\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"product\"}),`: {\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"id\"}),\": product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"id\"}),`,\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"tags\"}),`: [...tags],\n    },\n  };\n\n  `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Add tag if there are no products\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"if\"}),\" (!images.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"length\"}),\" \u0026\u0026 !tags.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"includes\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-variable constant_\",children:\"TAG_NO_PHOTOS\"}),`)) {\n    data.`,(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"product\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"push\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-variable constant_\",children:\"TAG_NO_PHOTOS\"}),`);\n  }\n\n  `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Remove tag if there are photos\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"if\"}),\" (images.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"length\"}),\" \u0026\u0026 tags.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"includes\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-variable constant_\",children:\"TAG_NO_PHOTOS\"}),`)) {\n    `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" index = data.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"product\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"indexOf\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-variable constant_\",children:\"TAG_NO_PHOTOS\"}),`);\n    data.`,(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"product\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"splice\"}),\"(index, \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"1\"}),`);\n  }\n\n  `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Update the tags if they've changed\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"if\"}),\" (tags.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"length\"}),\" !== data.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"product\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"tags\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"length\"}),`) {\n    `,(0,s.jsx)(e.span,{className:\"hljs-variable language_\",children:\"console\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"log\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"Updating tags for\"'}),\", product.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"id\"}),`);\n    `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" products = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" client.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"put\"}),`({\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"path\"}),\": \",(0,s.jsxs)(e.span,{className:\"hljs-string\",children:[\"`products/\",(0,s.jsx)(e.span,{className:\"hljs-subst\",children:\"${product.id}\"}),\".json`\"]}),`,\n      data,\n    });\n  }\n}\n`]})}),(0,s.jsxs)(e.p,{children:[\"Import the new file into \",(0,s.jsx)(e.code,{children:\"/web/webhook-handlers.js\"})]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\" } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"@shopify/shopify-api\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" shopify \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./shopify.js\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" productTagger \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./product-tagger.js\"'}),`;\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"default\"}),` {\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"PRODUCTS_UPDATE\"}),`: {\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"deliveryMethod\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"Http\"}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callbackUrl\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/api/webhooks\"'}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callback\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),` (topic, shop, body, webhookId) =\u003e {\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" sessionId = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"session\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"getOfflineId\"}),`(shop)\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" session = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"config\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"sessionStorage\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"loadSession\"}),`(sessionId);\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" client = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"new\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"clients\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Rest\"}),`({session});\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" product = \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"JSON\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"parse\"}),`(body);\n\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"productTagger\"}),`(client, product);\n    },\n  },\n  ...\n`]})}),(0,s.jsx)(e.p,{children:\"Modify a product again to make sure everything's working as expected!\"})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"11\",children:\"Implementing a queue\"}),(0,s.jsxs)(e.p,{children:[\"It's important to respond to Shopify's request with a \",(0,s.jsx)(e.code,{children:\"200 OK\"}),\" as quickly as possible. If a response isn't received within 5 seconds, Shopify will assume the request failed and retry at increasing intervals over a period of 48 hours.\"]}),(0,s.jsx)(e.p,{children:\"Right now, we're processing the webhook before responding. If we need to do additional work, or there's a delay with the tagging, we could easily exceed this 5 second window.\"}),(0,s.jsx)(e.p,{children:\"Let's improve this by storing the payload in a queue to process later. This allows our app to respond quickly, and our job can take as long as it likes to complete.\"}),(0,s.jsxs)(e.p,{children:[\"Stop the development server and install \",(0,s.jsx)(e.code,{children:\"better-queue\"}),\":\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:\"hljs language-bash\",children:`npm install -s better-queue\n`})}),(0,s.jsxs)(e.p,{children:[\"Create a new file: \",(0,s.jsx)(e.code,{children:\"/web/product-tagging-queue.js\"}),\":\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Queue\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"better-queue\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" productTagger \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./product-tagger.js\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" shopify \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./shopify.js\"'}),`;\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" productTaggingQueue = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"new\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Queue\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),` (input, done) =\u003e {\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),` { product, shop } = input;\n\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" sessionId = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"session\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"getOfflineId\"}),`(shop);\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" session = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"config\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"sessionStorage\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"loadSession\"}),`(sessionId);\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" client = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"new\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"clients\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Rest\"}),`({ session });\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"productTagger\"}),`(client, product);\n  `,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"done\"}),`();\n});\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"default\"}),` productTaggingQueue;\n`]})}),(0,s.jsxs)(e.p,{children:[\"And update the handler in \",(0,s.jsx)(e.code,{children:\"/web/webhook-handlers.js\"}),\":\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\" } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"@shopify/shopify-api\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" productTaggingQueue \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./product-tagging-queue.js\"'}),`;\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"default\"}),` {\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"PRODUCTS_UPDATE\"}),`: {\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"deliveryMethod\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"Http\"}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callbackUrl\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/api/webhooks\"'}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callback\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),` (topic, shop, body, webhookId) =\u003e {\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" product = \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"JSON\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"parse\"}),`(body);\n      productTaggingQueue.`,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"push\"}),`({shop, product});\n    },\n  },\n  ...\n`]})}),(0,s.jsxs)(e.dl,{children:[(0,s.jsx)(e.dt,{children:\"Positive\"}),(0,s.jsxs)(e.dd,{children:[\"In this example we're storing the queue in memory. For a production-ready app, be sure to use a \",(0,s.jsx)(e.a,{href:\"https://github.com/diamondio/better-queue#storage\",children:\"persistent data store\"}),\".\"]})]})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"12\",children:\"Handling duplicates\"}),(0,s.jsx)(e.p,{children:'The webhooks API provides \"at least once\" delivery of webhook events. This means that an endpoint might receive the same webhook event more than once.'}),(0,s.jsx)(e.p,{children:\"Let's update our handler to keep track of notifications by remembering each webhook's ID.\"}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\" } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"@shopify/shopify-api\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" productTaggingQueue \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./product-tagging-queue.js\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),` receievedWebhooks = {};\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"default\"}),` {\n  `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"PRODUCTS_UPDATE\"}),`: {\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"deliveryMethod\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"DeliveryMethod\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"Http\"}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callbackUrl\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/api/webhooks\"'}),`,\n    `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"callback\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),` (topic, shop, body, webhookId) =\u003e {\n      `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Check we haven't already receieved this webhook\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"if\"}),\" (receievedWebhooks[webhookId]) \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"return\"}),`;\n      `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Add to our list of receieved webhooks\"}),`\n      receievedWebhooks[webhookId] = `,(0,s.jsx)(e.span,{className:\"hljs-literal\",children:\"true\"}),`;\n      `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Add to our queue for processing\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" product = \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"JSON\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"parse\"}),`(body);\n      productTaggingQueue.`,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"push\"}),`({shop, product});\n    },\n  },\n  ...\n`]})}),(0,s.jsxs)(e.dl,{children:[(0,s.jsx)(e.dt,{children:\"Positive\"}),(0,s.jsx)(e.dd,{children:\"For simplicity, we're keeping this information in memory. For a production-ready app, be sure to use a persistent data store instead, like a database.\"})]})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"13\",children:\"Reconciliation jobs\"}),(0,s.jsx)(e.p,{children:`Webhook delivery isn't guaranteed, so it's best practice to implement reconciliation jobs to periodically fetch data from Shopify. You could do this in the background, or offer it to the merchant. Let's replace the \"Product Counter\" card with our own button that allows the merchant to sync tags.`}),(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/product-counter.jpg\",alt:\"product counter component\"})}),(0,s.jsxs)(e.p,{children:[\"In \",(0,s.jsx)(e.code,{children:\"/web/index.js\"}),\", import the product tagger and create an empty \",(0,s.jsx)(e.code,{children:\"reconciliation\"}),\" object to keep track of webhook IDs.\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[`...\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" productTagger \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"./product-tagger.js\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),` reconciliation = {};\n...\n`]})}),(0,s.jsxs)(e.p,{children:[\"Remove the \",(0,s.jsx)(e.code,{children:\"/api/products/count\"}),\" and \",(0,s.jsx)(e.code,{children:\"/api/products/create\"}),\" routes, and replace them with the following code.\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[\"app.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"get\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/api/products/tag\"'}),\", \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),` (req, res) =\u003e {\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" session = res.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"locals\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"shopify\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"session\"}),`;\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" client = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"new\"}),\" shopify.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"api\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"clients\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Rest\"}),`({ session });\n\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"let\"}),\" status = \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"200\"}),`;\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"let\"}),\" error = \",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:\"null\"}),`;\n\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"try\"}),` {\n    `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"let\"}),` params = {\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"path\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/products\"'}),`,\n      `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"query\"}),`: {\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"limit\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"250\"}),`,\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"fields\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"id, images, tags\"'}),`,\n        `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Lean on `updated_at_min` to only fetch products which\"}),`\n        `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// have been updated since the last time this process ran\"}),`\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"updated_at_min\"}),\": reconciliation[session.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"shop\"}),\"] || \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"\"'}),`,\n      },\n    };\n    `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Step through pagination\"}),`\n    `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"do\"}),` {\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" products = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" client.\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"get\"}),`(params);\n      `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Check tags\"}),`\n      `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"for\"}),\" (\",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" product \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"of\"}),\" products.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"body\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"products\"}),`) {\n        `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"productTagger\"}),`(client, product);\n      }\n      params = products?.`,(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"pageInfo\"}),\"?.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"nextPage\"}),`;\n    } `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"while\"}),\" (params !== \",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:\"undefined\"}),`);\n    `,(0,s.jsx)(e.span,{className:\"hljs-comment\",children:\"// Keep track of the last time this process runs\"}),`\n    reconciliation[session.`,(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"shop\"}),\"] = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"new\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Date\"}),\"().\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"toISOString\"}),`();\n    res.`,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"status\"}),\"(status).\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"send\"}),\"({ \",(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"success\"}),\": status === \",(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"200\"}),`, error });\n  } `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"catch\"}),` (e) {\n    `,(0,s.jsx)(e.span,{className:\"hljs-variable language_\",children:\"console\"}),\".\",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"log\"}),\"(\",(0,s.jsxs)(e.span,{className:\"hljs-string\",children:[\"`Failed to reconcile products: \",(0,s.jsx)(e.span,{className:\"hljs-subst\",children:\"${e.message}\"}),\"`\"]}),`);\n    status = `,(0,s.jsx)(e.span,{className:\"hljs-number\",children:\"500\"}),`;\n    error = e.`,(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"message\"}),`;\n  }\n});\n`]})}),(0,s.jsxs)(e.p,{children:[\"Finally, replace the ProductCard content in \",(0,s.jsx)(e.code,{children:\"/web/frontend/components/ProductCard.jsx\"}),\":\"]}),(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-javascript\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { useState } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"react\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Card\"}),\", \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"TextContainer\"}),\" } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"@shopify/polaris\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"Toast\"}),\" } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"@shopify/app-bridge-react\"'}),`;\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"import\"}),\" { useAuthenticatedFetch } \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"from\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"../hooks\"'}),`;\n\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"export\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"function\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"ProductsCard\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-params\"}),`) {\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" emptyToastProps = { \",(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"content\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:\"null\"}),` };\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" [isLoading, setIsLoading] = \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"useState\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:\"false\"}),`);\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" [toastProps, setToastProps] = \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"useState\"}),`(emptyToastProps);\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" fetch = \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"useAuthenticatedFetch\"}),`();\n\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" toastMarkup = toastProps.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"content\"}),` \u0026\u0026 (\n    `,(0,s.jsxs)(e.span,{className:\"xml\",children:[(0,s.jsxs)(e.span,{className:\"hljs-tag\",children:[\"\u003c\",(0,s.jsx)(e.span,{className:\"hljs-name\",children:\"Toast\"}),\" {\",(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"...toastProps\"}),\"} \",(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"onDismiss\"}),\"=\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"{()\"}),\" =\u003e\"]}),\" setToastProps(emptyToastProps)} /\u003e\"]}),`\n  );\n\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"handleReconcile\"}),\" = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"async\"}),\" (\",(0,s.jsx)(e.span,{className:\"hljs-params\"}),`) =\u003e {\n    `,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"setIsLoading\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:\"true\"}),`);\n    `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"const\"}),\" response = \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"await\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"fetch\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"/api/products/tag\"'}),`);\n\n    `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"if\"}),\" (response.\",(0,s.jsx)(e.span,{className:\"hljs-property\",children:\"ok\"}),`) {\n      `,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"setToastProps\"}),\"({ \",(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"content\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"Products have been reconciled!\"'}),` });\n      `,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"setIsLoading\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:\"false\"}),`);\n    } `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"else\"}),` {\n      `,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"setIsLoading\"}),\"(\",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:\"false\"}),`);\n      `,(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"setToastProps\"}),`({\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"content\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"There was an error reconciling products\"'}),`,\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"error\"}),\": \",(0,s.jsx)(e.span,{className:\"hljs-literal\",children:\"true\"}),`,\n      });\n    }\n  };\n\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"return\"}),` (\n    `,(0,s.jsxs)(e.span,{className:\"xml\",children:[(0,s.jsx)(e.span,{className:\"hljs-tag\",children:\"\u003c\u003e\"}),`\n      {toastMarkup}\n      `,(0,s.jsxs)(e.span,{className:\"hljs-tag\",children:[\"\u003c\",(0,s.jsx)(e.span,{className:\"hljs-name\",children:\"Card\"}),`\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"title\"}),\"=\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"Reconcile Products\"'}),`\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"sectioned\"}),`\n        `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"primaryFooterAction\"}),\"=\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"{{\"}),`\n          `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"content:\"}),' \"',(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"Reconcile\"}),`\",\n          `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"onAction:\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"handleReconcile\"}),`,\n          `,(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"loading:\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"isLoading\"}),`,\n        }}\n      \u003e`]}),`\n        `,(0,s.jsxs)(e.span,{className:\"hljs-tag\",children:[\"\u003c\",(0,s.jsx)(e.span,{className:\"hljs-name\",children:\"TextContainer\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-attr\",children:\"spacing\"}),\"=\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"loose\"'}),\"\u003e\"]}),`\n          `,(0,s.jsxs)(e.span,{className:\"hljs-tag\",children:[\"\u003c\",(0,s.jsx)(e.span,{className:\"hljs-name\",children:\"p\"}),\"\u003e\"]}),`\n            Occasionally we might miss some product updates. To check\n            everything's in sync, you can manually reconcile.\n          `,(0,s.jsxs)(e.span,{className:\"hljs-tag\",children:[\"\u003c/\",(0,s.jsx)(e.span,{className:\"hljs-name\",children:\"p\"}),\"\u003e\"]}),`\n        `,(0,s.jsxs)(e.span,{className:\"hljs-tag\",children:[\"\u003c/\",(0,s.jsx)(e.span,{className:\"hljs-name\",children:\"TextContainer\"}),\"\u003e\"]}),`\n      `,(0,s.jsxs)(e.span,{className:\"hljs-tag\",children:[\"\u003c/\",(0,s.jsx)(e.span,{className:\"hljs-name\",children:\"Card\"}),\"\u003e\"]}),`\n    `,(0,s.jsx)(e.span,{className:\"hljs-tag\",children:\"\u003c/\u003e\"})]}),`\n  );\n}\n`]})}),(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:\"/content/images/optimized/webhooks-in-nodejs/reconcile-products.jpg\",alt:\"reconcile products component\"})})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"14\",children:\"Conclusion\"}),(0,s.jsxs)(e.p,{children:[\"Congratulations! You've implemented webhooks and guarded against some common gotchas. The complete code \",(0,s.jsx)(e.a,{href:\"https://github.com/Shopify/workshop-webhooks-nodejs\",children:\"can be found here\"}),\".\"]}),(0,s.jsxs)(e.p,{children:[\"To learn more about webhooks, take a look at \",(0,s.jsx)(e.a,{href:\"https://shopify.dev/apps/webhooks/best-practices\",children:\"webhook best practices\"}),\". For more on shopify-api-node, \",(0,s.jsx)(e.a,{href:\"https://github.com/Shopify/shopify-api-node/tree/main/docs\",children:\"check out the docs\"}),\".\"]})]})}),(0,s.jsx)(e.div,{className:\"workshop-step\",children:(0,s.jsxs)(e.section,{children:[(0,s.jsx)(e.h2,{id:\"15\",children:\"Get ready to scale\"}),(0,s.jsx)(e.p,{children:\"Tracking traffic from Shopify's platform can be overwhelming, especially as you grow your app. If you need to manage large volumes of event notifications to build a scalable and reliable system, then you can configure subscriptions to send webhooks to Amazon EventBridge and Google Cloud Pub/Sub rather than through HTTPS.\"}),(0,s.jsxs)(e.p,{children:[\"Learn how to integrate your app with \",(0,s.jsx)(e.a,{href:\"https://shopify.dev/apps/webhooks/configuration/eventbridge\",children:\"Amazon EventBridge\"}),\" and \",(0,s.jsx)(e.a,{href:\"https://shopify.dev/apps/webhooks/configuration/google-cloud\",children:\"Google Cloud Pub/Sub\"}),\".\"]})]})})]})]})}function b(a={}){let{wrapper:e}=a.components||{};return e?(0,s.jsx)(e,Object.assign({},a,{children:(0,s.jsx)(o,a)})):o(a)}var v=b;function d(a,e){throw new Error(\"Expected \"+(e?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return k(_);})();\n;return Component;","frontmatter":{"id":"webhooks-in-nodejs","summary":"Get hands-on with Webhooks and avoid some common gotchas.","title":"Implementing Webhooks in Node.js","status":"Published","categories":"shopify, webhooks"},"trackingEnabled":true},"routes/workshops":null},"actionData":null,"errors":null},"future":{"v2_dev":false,"unstable_postcss":false,"unstable_tailwind":false,"v2_errorBoundary":false,"v2_headers":false,"v2_meta":false,"v2_normalizeFormMethod":false,"v2_routeConvention":false}};</script><script type="module" async="">import "/build/manifest-0FD511F1.js";
import * as route0 from "/build/root-TS7GWK7I.js";
import * as route1 from "/build/routes/workshops-YWZAAF22.js";
import * as route2 from "/build/routes/workshops/$workshopId-TCVFMZD7.js";
window.__remixRouteModules = {"root":route0,"routes/workshops":route1,"routes/workshops/$workshopId":route2};

import("/build/entry.client-J6TYPMOL.js");</script></body></html>